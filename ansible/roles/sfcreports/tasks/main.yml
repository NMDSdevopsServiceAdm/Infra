- name: Install Node
  ansible.builtin.apt:
    pkg: 
      - nodejs
      - npm
    update_cache: yes
    state: present

- name: Git checkout
  ansible.builtin.git:
    repo: 'https://github.com/NMDSdevopsServiceAdm/SFC-AnalysisFiles.git'
    dest: /home/ubuntu/SFC-AnalysisFiles

- name: Install SFC-AnalysisFiles node dependencies
  community.general.npm:
    path: /home/ubuntu/SFC-AnalysisFiles

- name: Create env file and add variables
  ansible.builtin.blockinfile:
    path: /home/ubuntu/.bashrc
    create: yes
    block: |
      export DATABASE_URL={{ DATABASE_URL }}
      export AWS_ACCESS_KEY_ID={{ AWS_ACCESS_KEY_ID }}
      export AWS_SECRET_ACCESS_KEY={{ AWS_SECRET_ACCESS_KEY }}
      export REPORTS_S3_BUCKET={{ REPORTS_S3_BUCKET }}
      export CRON={{ CRON }}
      export NODE_ENV={{ NODE_ENV }}
      export CRON_BENCHMARKS={{ CRON_BENCHMARKS }}
      export CRON_CQC_CHANGES={{ CRON_CQC_CHANGES }}

- name: Run the scheduler
  ansible.builtin.command:
    become_user: ubuntu
    chdir: /home/ubuntu/SFC-AnalysisFiles
    cmd: node src/index.js